{% extends "dashboard.html" %}

{% block title %}Consulta Contabilidad - SIUC{% endblock %}
{% block container_class %}justify-content-start align-items-start{% endblock %}

{% block content %}
<div class="container-fluid m-4">
    <div class="row mb-3">
        <div class="d-flex col justify-content-between align-items-center">
            <h3 class="fw-bold m-0">Contratos de Docentes</h3>
            {% if periodo_actual %}
                <h5 id="periodoVigente" class="m-0"><span class="fw-bold m-0">Periodo Vigente:</span> {{ periodo_actual.year }}-{{ periodo_actual.periodo }}</h5>
            {% else %}
                <h5 id="periodoVigente">No hay un periodo vigente en este momento.</h5>
            {% endif %}
        </div>
    </div>

    <div class="col-md-12">
        <div class="table-responsive overflow-x-auto">
            <table class="table table-striped table-hover mb-0 align-middle">
                <thead class="align-middle text-warp">
                    <tr>
                        <th colspan="4" class="col-4" scope="col">Información del Docente</th>
                        <th colspan="1" class="col-1" scope="col">Duración Contrato</th>
                        <th colspan="1" class="col-1" scope="col">Valor Hora</th>
                        <th colspan="1" class="col-1" scope="col">Valor Contrato</th>
                        <th colspan="3">Detalles del Contrato</th>
                        <th class="col-1" scope="col">
                            {% if "Contabilidad" in user_groups %}
                                <label for="aprobarTodosContabilidad" class="form-check-label fs-small">Aprobar todos</label>
                                <input type="checkbox" id="aprobarTodosContabilidad" class="form-check-input fs-small" data-rol="contabilidad">
                            {% elif "Rector" in user_groups %}
                                <label for="aprobarTodosRector" class="form-check-label fs-small">Aprobar todos</label>
                                <input type="checkbox" id="aprobarTodosRector" class="form-check-input fs-small" data-rol="rectoria">
                            {% elif "Presidente" in user_groups %}
                                <label for="aprobarTodosPresidencia" class="form-check-label fs-small">Aprobar todos</label>
                                <input type="checkbox" id="aprobarTodosPresidencia" class="form-check-input fs-small" data-rol="presidencia">
                            {% endif %}
                        </th>
                    </tr>
                </thead>
                    <tbody id="tablaContratosDocentesBody">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        fetch("/siuc/dashboard/docentes/contratos/", {
            headers: {
                "X-Requested-With": "XMLHttpRequest"
            }
        })
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById("tablaContratosDocentesBody");
            tbody.innerHTML = "";
            if (!data.contratos || data.contratos.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" class="text-center">No hay contratos de docentes.</td></tr>`;
            } else {
                data.contratos.forEach(contrato => {
                    let valorHoraHtml = contrato.tarifa_base_por_hora && contrato.tarifa_base_por_hora !== "" ? contrato.tarifa_base_por_hora : `<span class="fst-italic">No aplica</span>`;
                    let detallesDelContrato = "";
                    if (contrato.pago_por_mes && contrato.pago_por_mes.length > 0) {
                        if ("Contabilidad" in user_groups {
                            detallesDelContrato = `
                                <table class="table table-sm mb-0 w-100">
                                    <thead>
                                        <tr>
                                            ${contrato.pago_por_mes.map(detalle => `<td class="text-center"><span class="fw-bold">${detalle.mes}</span> - <span class="fst-italic fs-small">${detalle.dias} días</span></td>`).join('')}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            ${contrato.pago_por_mes.map(detalle => `<td class="text-center">${detalle.valor}`).join('')}
                                        </tr>
                                    </tbody>
                                </table>
                            `;
                        })
                    } elif ("Presidente" in user_groups) {
                        detallesDelContrato = `
                            <a href="#" id="revisarDetallesContrato" target="_blank" class="text-decoration-none">Ver detalles</a>
                        `;
                    } else {
                        detallesDelContrato = `<span class="fst-italic">Sin detalle</span>`;
                    }
                    tbody.innerHTML += `
                        <tr class="text-center fs-small">
                            <td colspan="1">${contrato.docente}</td>
                            <td colspan="1">${contrato.documento}</td>
                            <td colspan="1">${contrato.ultimo_nivel_estudio}</td>
                            <td colspan="1">${contrato.dedicacion}</td>
                            <td colspan="1" class="d-flex flex-column">
                                <span class="fw-bold">Inicio</span>${contrato.fecha_inicio}
                                <span class="fw-bold">Fin</span>${contrato.fecha_fin}
                            </td>
                            <td colspan="1">${valorHoraHtml}</td>
                            <td colspan="1">${contrato.valor_mensual_contrato}</td>
                            <td colspan="3">${detallesDelContrato}</td>
                            <td>
                                <input type="checkbox" class="form-check-input aprobar-carga-contabilidad" data-carga-id="${contrato.id}" ${contrato.aprobado_contabilidad ? 'checked' : ''}>
                            </td>
                        </tr>
                    `;
                });
            }
        });
    });
</script>
{% endblock %}