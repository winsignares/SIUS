{% extends "dashboard.html" %}

{% block title %}Matriz - SIUC{% endblock %}
{% block container_class %}justify-content-start align-items-start{% endblock %}

{% block content %}
<div class="container-fluid m-4">
    <!-- Título de la página -->
    <h3 class="mb-3 d-flex justify-content-center align-items-center fw-bold">Matriz Planta Docente</h3>

    <div class="row mb-3">
        <div class="d-flex justify-content-center align-items-center gap-3">
            <div class="d-flex col justify-content-between justify-middle align-items-center">
                {% if periodo_actual %}
                    <h5 id="periodoVigente" class="m-0"><span class="fw-bold m-0">Periodo Vigente:</span> {{ periodo_actual.year }}-{{ periodo_actual.periodo }}</h5>
                {% else %}
                    <h5 id="periodoVigente">No hay un periodo vigente en este momento.</h5>
                {% endif %}
                <h5 id="programaMatriz" class="m-0"><span class="fw-bold m-0">Programa:</span> {{ usuario_log.auth_user.first_name }}</h5>
            </div>
            <div class="vr"></div>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#agregarCargaModal">
                Agregar
            </button>
            <button id="guardarTodo" class="btn btn-primary">
                Guardar Todo
            </button>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="agregarCargaModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-forms modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Agregar Carga Académica</h4>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-2">
                    <form id="formAgregarCargaMatriz">
                        {% csrf_token %}
                        <div class"container">
                            <div class="container mb-3">
                                <div class="row px-3">
                                    <div class="col-md-5 mb-2">
                                        <label for="semestre" class="form-label">Semestre <span class="fw-bold fs-4">*</span></label>
                                        <select class="form-select" id="semestre" required>
                                            <option value="">Seleccione</option>
                                            {% for semestre in semestres_list %}
                                                <option value="{{ semestre.id }}">{{ semestre.semestre }} - {{ semestre.descripcion }} SEMESTRE</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-7 mb-2">
                                        <label for="materia" class="form-label">Materia <span class="fw-bold fs-4">*</span></label>
                                        <select class="form-select" id="materia" required>
                                            <option value="">Seleccione</option>
                                        </select>
                                    </div>

                                    <div class="col-md-3 mb-2">
                                        <label for="horas_semanales" class="form-label">Horas Semanales<span class="fw-bold fs-4"></span></label>
                                        <input type="number" class="form-control" id="horas_semanales" disabled>
                                    </div>

                                    <div class="col-md-9 mb-2" style="position: relative;">
                                        <label for="fk_docente_input_matriz" class="form-label">Docente <span class="fw-bold fs-4">*</span></label>
                                        <input type="text" id="fk_docente_input_matriz" class="form-control mb-2" placeholder="Buscar o escribir docente..." autocomplete="off">
                                        <ul id="fk_docente_dropdown_matriz" class="dropdown-menu">
                                            {% for docente in docentes_list %}
                                                <li>
                                                    <button class="dropdown-item" type="button" data-value="{{ docente.id }}">
                                                        {{ docente.primer_nombre }}{% if docente.segundo_nombre %} {{ docente.segundo_nombre }}{% endif %} {{ docente.primer_apellido }}{% if docente.segundo_apellido %} {{ docente.segundo_apellido }}{% endif %}
                                                    </button>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </div>

                                    <div class="col-md-12 mb-2 ms-2 form-check">
                                        <input type="checkbox" class="form-check-input" id="materia_compartida">
                                        <label class="form-check-label" for="materia_compartida">Materia Compartida</label>
                                    </div>

                                    <div id="materiasCompartidas" class="container">
                                        <div class="d-flex justify-content-center align-items-center row">
                                            <div class="col flex-column d-flex justify-content-center align-items-center col-md-5">
                                                <label class="form-label">Materias Disponibles</label>
                                                <select multiple class="form-select select-multiple" id="materiasDisponibles">
                                                    {% for materia in materias_compartidas %}
                                                        <option value="{{ materia.id }}">{{ materia.materia }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="d-flex flex-column justify-content-center align-items-center col-md-2">
                                                <button type="button" id="agregarMateria" class="btn-sm btn-primary mb-2">
                                                    <i class="bi bi-arrow-right-circle-fill"></i>
                                                </button>
                                                <button type="button" id="quitarMateria" class="btn-sm btn-primary">
                                                    <i class="bi bi-arrow-left-circle-fill"></i>
                                                </button>
                                            </div>
                                            <div class="col flex-column d-flex justify-content-center align-items-center col-md-5">
                                                <label class="form-label">Materias Elegidas</label>
                                                <select multiple class="form-select" id="permisosElegidos"></select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <!-- Botón para enviar el formulario -->
                <div class="modal-footer d-flex justify-content-between align-items-center">
                    <!-- Nota -->
                    <p class='mensaje-info fs-5'><span class='fw-bold'>NOTA:</span> Los campos marcados con ' <span class='fw-bold'>*</span> ' son obligatorios.</p>

                    <button type="button" class="btn btn-primary" id="agregarCarga">Agregar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de datos -->
    <div class="row">
        <div class="col-12">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-3 align-middle" id="infoAgregadaMatriz">
                    <thead class="align-middle text-warp">
                        <tr>
                            <th>Semestre</th>
                            <th>Materia</th>
                            <th>Docente</th>
                            <th>Dedicación</th>
                            <th>Horas Semanales (H)</th>
                            <th>Semanas (S)</th>
                            <th>Total (H * S)</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

<!-- Script para manejar la lista de materias -->
{% if materias_list %}
    {{ materias_list|json_script:"materiasJSON" }}
{% endif %}

<!-- Script para manejar la selección de materias según el semestre -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const materias = JSON.parse(document.getElementById("materiasJSON").textContent);
        const semestreSelect = document.getElementById("semestre");
        const materiaSelect = document.getElementById("materia");
        const horasInput = document.getElementById("horas_semanales");

        // Limpiar select de materias
        function clearMateriaSelect() {
            materiaSelect.innerHTML = '<option value="">Seleccione</option>';
        }

        // Al seleccionar semestre
        semestreSelect.addEventListener("change", function () {
            const semestreId = parseInt(this.value);
            clearMateriaSelect();
            horasInput.value = "";

            if (!semestreId) return;

            const materiasFiltradas = materias.filter(m => m.fk_semestre_id === semestreId);

            materiasFiltradas.forEach(m => {
                const option = document.createElement("option");
                option.value = m.id;
                option.textContent = `${m.codigo} - ${m.materia}`;
                option.setAttribute("data-horas", m.horas ?? "");
                materiaSelect.appendChild(option);
            });
        });

        // Al seleccionar materia, mostrar horas
        materiaSelect.addEventListener("change", function () {
            const selected = materiaSelect.options[materiaSelect.selectedIndex];
            const horas = selected.getAttribute("data-horas");
            horasInput.value = horas || "";
        });
    });
</script>

<!-- Script para filtrado en selects -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        function setupDropdownFilter(inputId, dropdownId) {
            const inputElement = document.getElementById(inputId);
            const dropdownElement = document.getElementById(dropdownId);
            const originalItems = Array.from(dropdownElement.querySelectorAll("button"));

            // Mostrar/ocultar el dropdown según el input
            inputElement.addEventListener("input", function () {
                const query = inputElement.value.toLowerCase();

                // Filtrar las opciones según el texto ingresado
                const filteredItems = originalItems.filter(item =>
                    item.textContent.toLowerCase().includes(query)
                );

                // Limpiar y actualizar el dropdown
                dropdownElement.innerHTML = "";
                if (filteredItems.length > 0) {
                    filteredItems.forEach(item => dropdownElement.appendChild(item.parentElement));
                    dropdownElement.style.display = "block";
                } else {
                    dropdownElement.style.display = "none";
                }
            });

            // Cuando seleccionas una opción
            dropdownElement.addEventListener("click", function (event) {
                if (event.target.matches(".dropdown-item")) {
                    const selectedText = event.target.textContent.trim(); // Elimina cualquier espacio extra
                    inputElement.value = selectedText; // Inserta solo el texto limpio
                    dropdownElement.style.display = "none"; // Oculta el dropdown
                }
            });

            // Ocultar el dropdown al hacer clic fuera
            document.addEventListener("click", function (event) {
                if (!event.target.closest(`#${inputId}`) && !event.target.closest(`#${dropdownId}`)) {
                    dropdownElement.style.display = "none";
                }
            });

            // Mostrar todas las opciones si el input está vacío
            inputElement.addEventListener("focus", function () {
                if (inputElement.value.trim() === "") {
                    dropdownElement.innerHTML = "";
                    originalItems.forEach(item => dropdownElement.appendChild(item.parentElement));
                    dropdownElement.style.display = "block";
                }
            });
        }

        // Reutiliza la función para diferentes inputs y dropdowns
        setupDropdownFilter("fk_docente_input_matriz", "fk_docente_dropdown_matriz");
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const agregarCargaBtn = document.getElementById("agregarCarga");
        const tablaBody = document.querySelector("#infoAgregadaMatriz tbody");

        // Aquí almacenaremos las cargas antes de enviarlas
        let cargasAcademicas = [];

        agregarCargaBtn.addEventListener("click", function (event) {
            event.preventDefault(); // Previene el submit automático del formulario

            const semestreSelect = document.getElementById("semestre");
            const materiaSelect = document.getElementById("materia");
            const docenteInput = document.getElementById("fk_docente_input_matriz");
            const horasInput = document.getElementById("horas_semanales");
            const materiaCompartidaCheckbox = document.getElementById("materia_compartida");

            const semestreText = semestreSelect.options[semestreSelect.selectedIndex].text;
            const semestreId = semestreSelect.value;
            const materiaText = materiaSelect.options[materiaSelect.selectedIndex].text;
            const materiaId = materiaSelect.value;
            const docenteNombre = docenteInput.value.trim();
            const horasSemanales = horasInput.value;
            const materiaCompartida = materiaCompartidaCheckbox.checked;
            const semanas = 16; // Asumiendo siempre 16 semanas, si no quieres eso, lo haces dinámico
            const totalHoras = horasSemanales * semanas;

            // Validaciones mínimas
            if (!semestreId || !materiaId || !docenteNombre || !horasSemanales) {
                alert("Por favor completa todos los campos obligatorios.");
                return;
            }

            // Creamos el objeto que representa una fila de carga académica
            const nuevaCarga = {
                semestre_id: semestreId,
                semestre_nombre: semestreText,
                materia_id: materiaId,
                materia_nombre: materiaText,
                docente_nombre: docenteNombre,
                horas_semanales: horasSemanales,
                materia_compartida: materiaCompartida,
                semanas: semanas,
                total: totalHoras
            };

            cargasAcademicas.push(nuevaCarga); // Agregamos al arreglo

            // Agregamos la fila a la tabla visualmente
            const fila = document.createElement("tr");
            fila.innerHTML = `
                <td>${nuevaCarga.semestre_nombre}</td>
                <td>${nuevaCarga.materia_nombre}</td>
                <td>${nuevaCarga.docente_nombre}</td>
                <td>Tiempo Completo</td>
                <td>${nuevaCarga.horas_semanales}</td>
                <td>${nuevaCarga.semanas}</td>
                <td>${nuevaCarga.total}</td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm eliminarFila">Eliminar</button>
                </td>
            `;
            tablaBody.appendChild(fila);

            // Reseteamos el formulario (no cierra el modal)
            document.getElementById("formAgregarCargaMatriz").reset();
        });

        // Eliminar fila
        tablaBody.addEventListener("click", function (event) {
            if (event.target.classList.contains("eliminarFila")) {
                const fila = event.target.closest("tr");
                const index = Array.from(tablaBody.children).indexOf(fila);

                cargasAcademicas.splice(index, 1); // Eliminamos del array
                fila.remove(); // Eliminamos visualmente
            }
        });
    });
</script>
{% endblock %}